<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obter IP do Usuário</title>
    <style>
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <p>Seu IP é: <span id="userIp"></span></p>
    <p class="error" id="error"></p>
    <button onclick="getUserIP()">Atualizar IP</button>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDuCbv6JJQ4Nb3NaOJbp6KLxs2AzK3s1K8",
            authDomain: "loja1-e7ead.firebaseapp.com",
            projectId: "loja1-e7ead",
            storageBucket: "loja1-e7ead.appspot.com",
            messagingSenderId: "836629331904",
            appId: "1:836629331904:web:32e23815a473f277511225",
            measurementId: "G-5XCVGHQWKX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase();

        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) {
                    throw new Error("Erro na resposta da API");
                }
                const data = await response.json();
                const userIP = data.ip;
                
                // Verifica se o IP está na lista de bloqueados
                if (await isIPBlocked(userIP)) {
                    document.getElementById("error").textContent = "IP bloqueado. Acesso negado.";
                    document.getElementById("userIp").textContent = "";
                    return;
                }

                document.getElementById("userIp").textContent = userIP;

                // Verifica se é uma pré-visualização de link
                const userAgent = navigator.userAgent.toLowerCase();
                if (userAgent.includes("facebookexternalhit") || userAgent.includes("whatsapp")) {
                    await saveIPToDatabase(userIP, true);  // Salva como IP de pré-visualização
                } else {
                    await saveIPToDatabase(userIP, false); // Salva como IP normal
                }
                
                document.getElementById("error").textContent = ""; // Limpa qualquer mensagem de erro anterior
            } catch (error) {
                document.getElementById("error").textContent = "Erro ao obter o IP: " + error.message;
                console.error("Erro ao obter o IP:", error);
            }
        }

        async function saveIPToDatabase(ip, isPreview) {
            const timestamp = Date.now();
            const data = {
                ip: ip,
                timestamp: timestamp,
                isPreview: isPreview
            };
            await set(ref(db, 'ips/' + timestamp), data)
                .then(() => {
                    console.log("IP salvo com sucesso");
                })
                .catch((error) => {
                    document.getElementById("error").textContent = "Erro ao salvar o IP no Firebase: " + error.message;
                    console.error("Erro ao salvar o IP no Firebase:", error);
                });
        }

        async function isIPBlocked(ip) {
            const snapshot = await get(child(ref(db), 'blockedIps'));
            if (snapshot.exists()) {
                const blockedIps = snapshot.val();
                return Object.values(blockedIps).some(blockedIp => blockedIp.ip === ip);
            }
            return false;
        }

        // Torna a função globalmente acessível
        window.getUserIP = getUserIP;

        // Chama a função ao carregar a página
        getUserIP();
    </script>
</body>
</html>
